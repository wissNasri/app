name: DAST Scan avec Nginx Reverse Proxy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  dast-scan:
    runs-on: ubuntu-latest
    name: Lancer, Exposer avec Nginx/ngrok et Scanner

    steps:
      - name: 1. Cloner le code du projet
        uses: actions/checkout@v4

      - name: 2. Construire et lancer les services avec Docker Compose
        run: |
          echo "Construction des images et démarrage de la pile applicative (avec Nginx)..."
          docker compose -f app/docker-compose.yml up --build -d

      - name: 3. Attendre que Nginx soit prêt
        run: |
          echo "Attente du démarrage du reverse proxy Nginx sur le port 80..."
          timeout 120s bash -c 'until curl -s http://localhost:80 > /dev/null; do echo "En attente de Nginx..."; sleep 5; done'
          echo "Nginx est prêt !"

      - name: 4. Installer et lancer ngrok
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | sudo tar xvz -C /usr/local/bin
          ngrok config add-authtoken $NGROK_AUTHTOKEN
          # On expose le port 80 (Nginx ) et on logue l'URL
          ngrok http 80 --log=stdout > ngrok.log &
          sleep 5

      - name: 5. Afficher l'URL publique et scanner
        id: scan
        run: |
          PUBLIC_URL=$(grep -o 'url=https://[0-9a-zA-Z.-]*\.ngrok-free\.app' ngrok.log | cut -d'=' -f2 )
          echo "################################################"
          echo "## L'application est accessible à l'adresse suivante :"
          echo "## $PUBLIC_URL"
          echo "################################################"
          echo "public_url=$PUBLIC_URL" >> $GITHUB_OUTPUT

      - name: 6. Lancer le scan de sécurité DAST (OWASP ZAP)
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: ${{ steps.scan.outputs.public_url }}
          
      - name: 7. Arrêter tous les services
        if: always()
        run: |
          echo "Arrêt des conteneurs Docker..."
          docker compose -f app/docker-compose.yml down
          echo "Arrêt de l'agent ngrok..."
          # On s'assure que le processus ngrok est bien terminé
          pkill ngrok || true
